<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Testing EJAM App with Shinytests • EJAM</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Testing EJAM App with Shinytests">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">EJAM</a>

    <small class="nav-text text-warning me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">2.32.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Overview for EJAM Users</h6></li>
    <li><a class="dropdown-item" href="../articles/0_whatis.html">What is EJAM?</a></li>
    <li><a class="dropdown-item" href="../articles/0_webapp.html">Accessing the Web App</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>For analysts using R</h6></li>
    <li><a class="dropdown-item" href="../articles/1_installing.html">Installing the EJAM R package</a></li>
    <li><a class="dropdown-item" href="../articles/2_quickstart.html">Quick Start Guide</a></li>
    <li><a class="dropdown-item" href="../articles/3_analyzing.html">Using EJAM for Analysis in R</a></li>
    <li><a class="dropdown-item" href="../articles/4_advanced.html">Advanced Features</a></li>
    <li><a class="dropdown-item" href="../articles/zipcodes.html">Zipcodes</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>For package developers</h6></li>
    <li><a class="dropdown-item" href="../articles/dev_deploy-app.html">Deploy EJAM Application</a></li>
    <li><a class="dropdown-item" href="../articles/dev_update-datasets.html">Update EJAM Datasets</a></li>
    <li><a class="dropdown-item" href="../articles/dev_update-package.html">Update EJAM Package</a></li>
    <li><a class="dropdown-item" href="../articles/dev_run-unit-tests.html">Package Contributors - Running Unit Tests</a></li>
    <li><a class="dropdown-item" href="../articles/dev_run-shinytests.html">Testing EJAM App with Shinytests</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Testing EJAM App with Shinytests</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/USEPA/EJAM-open/blob/HEAD/vignettes/dev_run-shinytests.Rmd" class="external-link"><code>vignettes/dev_run-shinytests.Rmd</code></a></small>
      <div class="d-none name"><code>dev_run-shinytests.Rmd</code></div>
    </div>

    
    
<p>This document outlines the general development process for updating
EJAM, including the surrounding GitHub infrastructure.</p>
<div class="section level2">
<h2 id="dev-environment">Dev Environment<a class="anchor" aria-label="anchor" href="#dev-environment"></a>
</h2>
<p>If you are successfully running the app, you should have all the
necessary packages. If you don’t, those packages should live in the
<code>DESCRIPTION</code> file. However, there are some dev-related
packages you may not have:</p>
<ul>
<li><strong>Shinytest2</strong></li>
<li><strong>Diffviewer</strong></li>
<li>
<strong>PhantomJS</strong> – Needed for downloads (install with
<code><a href="http://wch.github.io/webshot/reference/install_phantomjs.html" class="external-link">webshot::install_phantomjs()</a></code>)</li>
<li>
<strong>Pandoc</strong> – May come with RStudio; different ways to
install</li>
</ul>
</div>
<div class="section level2">
<h2 id="how-shinytest2-works">How Shinytest2 Works<a class="anchor" aria-label="anchor" href="#how-shinytest2-works"></a>
</h2>
<p>Shinytest2 (henceforth “shinytest”) automates app functionality
testing, so we can determine if code updates break or unexpectedly
modify parts of an application.</p>
<p>It runs the installed version of the app in a headless Chromium
browser, simulating user interactions and taking snapshots. These
snapshots are stored as JSON files with accompanying PNG images. If
differences arise from code updates, the test fails, indicating which
files changed.</p>
<div class="section level3">
<h3 id="key-features">Key Features:<a class="anchor" aria-label="anchor" href="#key-features"></a>
</h3>
<ul>
<li>Compares <code>.json</code>, <code>.html</code>, <code>.xlsx</code>
files to a baseline</li>
<li>Snapshots include inputs, outputs, and exported values</li>
<li>
<code>.png</code> files provide visual confirmation (but do not
cause test failures)</li>
<li>Developers can update snapshots to set a new baseline</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="ejams-shinytest-folder-structure">EJAM’s Shinytest Folder Structure<a class="anchor" aria-label="anchor" href="#ejams-shinytest-folder-structure"></a>
</h2>
<pre class="plaintext"><code>tests/
  ├── testthat.R (modified for shinytest2)
  ├── app-functionality.R
  └── testthat/
      ├── setup-shinytest2.R
      ├── test-[DATA TYPE]-functionality.R (e.g. test-FIPS-functionality.R)
      └── _snaps/
          ├── [OS, e.g. linux]-[R Version, e.g. 4.4]/
          │   ├── FIPS-shiny-functionality/
          │   │   ├── .json, .png, .xlsx, .html files
          │   ├── shapefile-shiny-functionality/
          │   │   ├── .json, .png, .xlsx, .html files
          │   ├── latlon-shiny-functionality/
          │   │   ├── .json, .png, .xlsx, .html files
          │   ├── NAICS-shiny-functionality/
          │   │   ├── .json, .png, .xlsx, .html files
          │   └── FRS-shiny-functionality/
          │   │   ├── .json, .png, .xlsx, .html files</code></pre>
<div class="section level3">
<h3 id="file-descriptions">File Descriptions<a class="anchor" aria-label="anchor" href="#file-descriptions"></a>
</h3>
<ul>
<li>
<strong><code>testthat.R</code></strong> – Calls
<code><a href="https://rstudio.github.io/shinytest2/reference/test_app.html" class="external-link">shinytest2::test_app()</a></code> to run all tests. Can filter
specific tests using <code>filter="test-name"</code>.</li>
<li>
<strong><code>_snaps/</code></strong> – Stores snapshots categorized
by OS, R version, and data type.</li>
<li>
<strong><code>setup-shinytest2.R</code></strong> – Loads
<code>global.R</code> and app scripts into the testing environment.</li>
<li>
<strong><code>app-functionality.R</code></strong> – Generic function
that defines app interactions for testing, running tests for multiple
data types (FIPS, shapefile, latlon, NAICS, etc.).</li>
<li>
<strong><code>test-[DATA TYPE]-functionality.R</code></strong> –
Simple call to the main app functionality function, specifying the data
type to test with.</li>
<li>
<strong><code>.json</code> files</strong> – Capture app
snapshots.</li>
<li>
<strong><code>.png</code> files</strong> – Screenshots (do not
trigger failures).</li>
<li>
<strong><code>.xlsx</code> &amp; <code>.html</code> files</strong> –
Download files. Compared via content hashing to prevent false
failures.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="updating-tests">Updating Tests<a class="anchor" aria-label="anchor" href="#updating-tests"></a>
</h2>
<p>You may wish to modify the shinytest scripts, either to add new
interactions with the application or to modify existing ones, such as in
the case of an app component that can no longer be interacted with. Here
are some methods and tips for updating the shinytest script
accordingly.</p>
<div class="section level3">
<h3 id="direct-updates">Direct Updates<a class="anchor" aria-label="anchor" href="#direct-updates"></a>
</h3>
<p>Modify <code>app-functionality.R</code> to add new interactions with
the app for the shinytest to test.</p>
</div>
<div class="section level3">
<h3 id="using-shinytest2record_test-to-generate-testing-code">Using <code>shinytest2::record_test()</code> to generate testing
code<a class="anchor" aria-label="anchor" href="#using-shinytest2record_test-to-generate-testing-code"></a>
</h3>
<p>If you’re not sure how to code interactions directly, run this commad
to test the app interactively and record your actions, which can then be
copied into test scripts.</p>
</div>
<div class="section level3">
<h3 id="using-exporttestvaluesname-value">Using <code>exportTestValues(name = value)</code><a class="anchor" aria-label="anchor" href="#using-exporttestvaluesname-value"></a>
</h3>
<p>Throughout the app code, this can be used to store values from
reactive expressions or other items that are not inputs or outputs and
therefore may not be included in the standard snapshots. Then, in the
shinytests, you can specify <code>export=[name]</code> to include in the
snapshot the export named “name” that you specified in the code, or
<code>export=TRUE</code> to include all exports.</p>
</div>
</div>
<div class="section level2">
<h2 id="running-tests-locally">Running Tests Locally<a class="anchor" aria-label="anchor" href="#running-tests-locally"></a>
</h2>
<p>The primary method for running the shinytests is:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">shinytest2</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/shinytest2/reference/test_app.html" class="external-link">test_app</a></span><span class="op">(</span><span class="st">"."</span>, filter<span class="op">=</span><span class="st">"-functionality"</span><span class="op">)</span></span></code></pre></div>
<p>However, it is strongly recommended during development to run the
entire <code>testthat.R</code> which runs
<code><a href="https://remotes.r-lib.org/reference/install_local.html" class="external-link">remotes::install_local</a></code> to ensure your development code is
the one tested. This is because shinytest automatically references the
installed version of a package.</p>
</div>
<div class="section level2">
<h2 id="github-actions-integration">GitHub Actions Integration<a class="anchor" aria-label="anchor" href="#github-actions-integration"></a>
</h2>
<p>Using GitHub Actions (GHA) we can have GitHub run our shinytests
prior to merging a Pull Request, to give us peace of mind that the app
will still work with the merged code.</p>
<div class="section level3">
<h3 id="workflow">Workflow<a class="anchor" aria-label="anchor" href="#workflow"></a>
</h3>
<ul>
<li>PRs to <code>development</code>, <code>main</code>, or
<code>deploy-posit</code> trigger GHA workflows.</li>
<li>GHA sets up R, installs dependencies, runs tests, and compares
snapshots.</li>
<li>The workflow is stored in
<code>.github/workflows/run-test.yaml</code>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="speed-optimization">Speed Optimization<a class="anchor" aria-label="anchor" href="#speed-optimization"></a>
</h3>
<ul>
<li>If GHA takes too long, cache dependencies by temporarily disabling
steps after setup.</li>
<li>If snapshots fail, merge the base branch into the feature branch
before updating snapshots.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="reviewing-updating-snapshots">Reviewing &amp; Updating Snapshots<a class="anchor" aria-label="anchor" href="#reviewing-updating-snapshots"></a>
</h2>
<div class="section level3">
<h3 id="reviewing">Reviewing<a class="anchor" aria-label="anchor" href="#reviewing"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/snapshot_accept.html" class="external-link">snapshot_review</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Optionally, can filter to review specific files or folders of
snapshots.</p>
</div>
<div class="section level3">
<h3 id="accepting-new-snapshots">Accepting New Snapshots<a class="anchor" aria-label="anchor" href="#accepting-new-snapshots"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/snapshot_accept.html" class="external-link">snapshot_accept</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Optionally, can accept them interactively when reviewing</p>
</div>
</div>
<div class="section level2">
<h2 id="debugging-tests-github-actions">Debugging Tests &amp; GitHub Actions<a class="anchor" aria-label="anchor" href="#debugging-tests-github-actions"></a>
</h2>
<div class="section level3">
<h3 id="debugging-shinytest2">Debugging Shinytest2<a class="anchor" aria-label="anchor" href="#debugging-shinytest2"></a>
</h3>
<ul>
<li>Use <code>save_log()</code> to inspect logs.</li>
<li>Add <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code>, <code><a href="https://rdrr.io/r/base/message.html" class="external-link">message()</a></code>, or
<code><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning()</a></code> statements in
<code>app-functionality.R</code>.</li>
<li>Run, line-by line or in chunks, the main shinytest code in
<code>app-functionality.R</code> beginning with:</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">test_category</span> <span class="op">&lt;-</span> <span class="st">"NAICS-functionality"</span></span>
<span>  <span class="va">test_snap_dir</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{normalizePath(testthat::test_path())}/_snaps/{platform_variant()}/{test_category}-functionality/"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">outputs_to_remove</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'an_leaf_map'</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="va">app</span> <span class="op">&lt;-</span> <span class="va">AppDriver</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    variant <span class="op">=</span> <span class="fu">platform_variant</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="va">test_category</span>, </span>
<span>    seed<span class="op">=</span><span class="fl">12345</span>, </span>
<span>    load_timeout<span class="op">=</span><span class="fl">2e+06</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">1920</span>,</span>
<span>    screenshot_args <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    expect_values_screenshot_args <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    height <span class="op">=</span> <span class="fl">1080</span>,</span>
<span>    options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      shiny.reactlog <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>      shiny.trace <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Then, after running lines or chunks, run <code>app$get_log()</code>
to view the log.</p>
</div>
<div class="section level3">
<h3 id="debugging-gha">Debugging GHA<a class="anchor" aria-label="anchor" href="#debugging-gha"></a>
</h3>
<p>Generally, if you test locally and update snapshots accordingly, GHA
should pass. However, the tests do sometimes fail due to OS differences,
R version differences, or even package differences. Here are some tips
for debugging these issues:</p>
<ul>
<li>Inspect the log in the GitHub repo, under the Actions tab or the
Checks tab of the PR.</li>
<li>Inspect artifacts (zipped test outputs) after a failed run and
compare snapshots in a diff viewer to identify discrepancies.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="current-state-of-tests">Current State of Tests<a class="anchor" aria-label="anchor" href="#current-state-of-tests"></a>
</h2>
<ul>
<li>As of 4/2/2025, the shinytests may be failing, as snapshots have not
been updated locally and pushed after recent changes.</li>
<li>The current version of R used for testing is 4.4.1 and should
reflect the version used in your development environment, to ensure
consistency as much as possible.</li>
</ul>
</div>
<div class="section level2">
<h2 id="resources">Resources<a class="anchor" aria-label="anchor" href="#resources"></a>
</h2>
<p><a href="https://rstudio.github.io/shinytest2/reference/AppDriver.html#method-AppDriver-expect_download" class="external-link">RStudio
Shinytest2 Documentation</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>US EPA 2025</p>
</div>

<div class="pkgdown-footer-right">
  <p>EJAM Version 2.32.2</p>
</div>

    </footer>
</div>





  </body>
</html>
